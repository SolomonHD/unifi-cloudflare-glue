# S3 Backend Configuration Template for AWS Secrets Manager Integration
# This template uses vals to inject secrets from AWS Secrets Manager at runtime.
#
# Prerequisites:
#   1. Install vals: https://github.com/helmfile/vals
#   2. Install AWS CLI: https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html
#   3. Configure credentials: aws configure
#
# Required AWS Secrets:
#   - Secret: "terraform-aws-access-key" (plain string or JSON key)
#   - Secret: "terraform-aws-secret-key" (plain string or JSON key)
#
#   OR create a combined JSON secret:
#   aws secretsmanager create-secret \
#     --name terraform-aws-credentials \
#     --secret-string '{"access_key":"AKIA...","secret_key":"..."}'
#
# Usage:
#   # Render the template (creates backend.yaml with actual secrets)
#   vals eval -f s3-backend-aws-secrets.yaml.tmpl > backend.yaml
#
#   # Deploy with rendered backend
#   dagger call deploy \
#       --backend-type=s3 \
#       --backend-config-file=./backend.yaml \
#       --kcl-source=./kcl \
#       ...
#
#   # Clean up rendered secrets immediately after use
#   rm backend.yaml
#
# vals Reference Formats:
#   - Plain secret: ref+awssecretsmanager://secret-name
#   - JSON key: ref+awssecretsmanager://secret-name#key
#   - Specific region: ref+awssecretsmanager://secret-name?region=us-west-2
#   - With profile: ref+awssecretsmanager://secret-name?profile=production
#
# Security Notes:
#   - NEVER commit rendered .yaml files to version control
#   - Add *.yaml (but not *.yaml.tmpl) to .gitignore
#   - Use automated cleanup with Makefile to prevent secret leaks

bucket: my-terraform-state-bucket
key: unifi-cloudflare-glue/terraform.tfstate
region: us-east-1
encrypt: true
dynamodb_table: terraform-state-lock

# AWS Secrets Manager vals references
# Format: ref+awssecretsmanager://<secret-name>
access_key: ref+awssecretsmanager://terraform-aws-access-key
secret_key: ref+awssecretsmanager://terraform-aws-secret-key

# Alternative: Using JSON secret with key extraction
# access_key: ref+awssecretsmanager://terraform-aws-credentials#access_key
# secret_key: ref+awssecretsmanager://terraform-aws-credentials#secret_key

# Optional: Static credentials (not recommended - use vals instead)
# Uncomment below if not using vals secret injection
# access_key: "AKIAIOSFODNN7EXAMPLE"
# secret_key: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
